<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <title>Mini LMS – ЭОО</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: #020617;
      --bg-elevated: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --danger: #f97373;
      --success: #4ade80;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
      padding: 16px;
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      padding: 16px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .title-block p {
      margin: 2px 0 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      font-size: 0.8rem;
      color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
      white-space: nowrap;
    }

    .section-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 12px;
      margin-bottom: 14px;
    }

    @media (max-width: 720px) {
      .section-grid { grid-template-columns: 1fr; }
    }

    .section {
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      padding: 10px 12px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.05), #020617);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .section-tag {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
    }

    .section-body {
      font-size: 0.85rem;
      color: var(--text-muted);
      max-height: 230px;
      overflow-y: auto;
      padding-right: 4px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .link-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer;
      text-decoration: none;
    }

    .quiz-container { margin-top: 6px; }

    .question {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed var(--border-subtle);
    }

    .question-title {
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      margin-bottom: 2px;
    }

    .option input { transform: scale(0.9); }

    .quiz-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-primary {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      background: var(--accent);
      color: #020617;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .result-text {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .result-text.success { color: var(--success); }
    .result-text.fail    { color: var(--danger); }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      margin-right: 4px;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .error {
      font-size: 0.8rem;
      color: var(--danger);
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="header">
      <div class="title-block">
        <h1>ЭОО • Mini LMS</h1>
        <p id="lessonTitle">Сабақ жүктелуде...</p>
      </div>
      <div class="badge">Telegram WebApp</div>
    </div>

    <div class="status-bar">
      <div class="status-left">
        <div class="dot"></div>
        <span id="statusText">GitHub-тан деректер жүктелуде...</span>
      </div>
      <span id="userName"></span>
    </div>

    <div style="height:8px;"></div>

    <div class="section-grid">
      <!-- Презентация (PDF) -->
      <section class="section">
        <div class="section-header">
          <span class="section-title">Презентация (PDF)</span>
          <span class="section-tag">GitHub</span>
        </div>
        <div class="section-body" id="presentationBody">
          PDF-сілтеме дайындалуда...
        </div>
      </section>

      <!-- Теория (PDF) -->
      <section class="section">
        <div class="section-header">
          <span class="section-title">Теория (PDF)</span>
          <span class="section-tag">GitHub</span>
        </div>
        <div class="section-body" id="theoryBody">
          PDF-сілтеме дайындалуда...
        </div>
      </section>
    </div>

    <!-- Тест бөлігі -->
    <section class="section">
      <div class="section-header">
        <span class="section-title">Бақылау сұрақтары</span>
        <span class="section-tag">Тест • GitHub</span>
      </div>
      <div class="section-body">
        <div id="quizContainer" class="quiz-container">
          Сұрақтар жүктелуде...
        </div>

        <div class="quiz-actions">
          <button id="submitQuizBtn" class="btn-primary" disabled>Тестті аяқтау</button>
          <span id="quizResult" class="result-text"></span>
        </div>
      </div>
    </section>

    <div id="globalError" class="error" style="display:none;"></div>
  </div>
</div>

<script>
  // ================== КОНФИГ ==================

  // Сабақ атауы (осыны өзгертіп қоясың)
  const LESSON_TITLE = "Сабақтың атауы осында";

  // PDF-тердің нақты сілтемелерін осында қоясың
  // Мысалы:
  // https://github.com/user/repo/blob/main/lesson1/theory.pdf?raw=1
  const GITHUB_THEORY_PDF_URL =
    "https://github.com/AR94NUR/telegram-lms/blob/main/lesson1/1-ТАҚЫРЫП.pdf?raw=1";

  const GITHUB_PRESENTATION_PDF_URL =
    "https://github.com/AR94NUR/telegram-lms/blob/main/lesson1/1-taqirip.pdf?raw=1";

  // Тест сұрақтары .txt түрінде (raw link!)
  const GITHUB_QUESTIONS_URL =
    "https://raw.githubusercontent.com/AR94NUR/telegram-lms/refs/heads/main/lesson1/questions.txt";

  const tg = window.Telegram?.WebApp;

  if (tg) {
    tg.expand();
    tg.ready();
  }

  function setUserName() {
    try {
      const user = tg?.initDataUnsafe?.user;
      if (user) {
        const name = (user.first_name || "") + " " + (user.last_name || "");
        document.getElementById("userName").textContent = name.trim();
      }
    } catch (e) {}
  }

  setUserName();

  function setStatus(text) {
    const el = document.getElementById("statusText");
    if (el) el.textContent = text;
  }

  function setGlobalError(msg) {
    const el = document.getElementById("globalError");
    if (!el) return;
    if (!msg) {
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = msg;
  }

  async function safeFetch(url) {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error("HTTP " + response.status + " – " + url);
    }
    return await response.text();
  }

  // ================== PDF-LINK РЕНДЕР ==================

  function renderPdfLinks() {
    document.getElementById("lessonTitle").textContent = LESSON_TITLE;

    const presBody = document.getElementById("presentationBody");
    const theoryBody = document.getElementById("theoryBody");

    presBody.innerHTML = "";
    theoryBody.innerHTML = "";

    if (GITHUB_PRESENTATION_PDF_URL) {
      const a = document.createElement("a");
      a.href = GITHUB_PRESENTATION_PDF_URL;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.className = "link-btn";
      a.textContent = "Презентацияны ашу (PDF)";
      presBody.appendChild(a);
    } else {
      presBody.textContent = "Презентация PDF сілтемесі орнатылмаған.";
    }

    if (GITHUB_THEORY_PDF_URL) {
      const a = document.createElement("a");
      a.href = GITHUB_THEORY_PDF_URL;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.className = "link-btn";
      a.textContent = "Теорияны ашу (PDF)";
      theoryBody.appendChild(a);
    } else {
      theoryBody.textContent = "Теория PDF сілтемесі орнатылмаған.";
    }
  }

  // ================== ТЕСТ СҰРАҚТАРЫ ==================

  function parseQuestions(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const result = [];

    for (const line of lines) {
      const parts = line.split("|").map(p => p.trim());
      if (parts.length < 6) continue;

      const [q, a, b, c, d, correctRaw] = parts;
      const correctIndex = parseInt(correctRaw, 10) - 1;

      if (isNaN(correctIndex) || correctIndex < 0 || correctIndex > 3) continue;

      result.push({
        text: q,
        options: [a, b, c, d],
        correctIndex
      });
    }

    return result;
  }

  let quizData = [];

  function renderQuiz() {
    const container = document.getElementById("quizContainer");
    if (!quizData.length) {
      container.textContent = "Сұрақтар әзірге жоқ.";
      document.getElementById("submitQuizBtn").disabled = true;
      return;
    }

    container.innerHTML = "";

    quizData.forEach((q, qi) => {
      const qDiv = document.createElement("div");
      qDiv.className = "question";

      const title = document.createElement("div");
      title.className = "question-title";
      title.textContent = (qi + 1) + ". " + q.text;
      qDiv.appendChild(title);

      q.options.forEach((opt, oi) => {
        const label = document.createElement("label");
        label.className = "option";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "q" + qi;
        input.value = String(oi);

        label.appendChild(input);
        label.appendChild(document.createTextNode(opt));
        qDiv.appendChild(label);
      });

      container.appendChild(qDiv);
    });

    document.getElementById("submitQuizBtn").disabled = false;
  }

  async function loadQuestions() {
    const container = document.getElementById("quizContainer");
    try {
      const text = await safeFetch(GITHUB_QUESTIONS_URL);
      quizData = parseQuestions(text);
      renderQuiz();
    } catch (e) {
      console.error(e);
      container.textContent = "Сұрақтарды жүктеу кезінде қате.";
      setGlobalError("Тест сұрақтарын GitHub-тен жүктеу мүмкін болмады.");
      document.getElementById("submitQuizBtn").disabled = true;
    }
  }

  function calculateQuizResult() {
    if (!quizData.length) return { score: 0, total: 0 };

    let correct = 0;
    quizData.forEach((q, qi) => {
      const selected = document.querySelector('input[name="q' + qi + '"]:checked');
      if (!selected) return;
      const idx = parseInt(selected.value, 10);
      if (idx === q.correctIndex) correct++;
    });

    return { score: correct, total: quizData.length };
  }

  function handleSubmitQuiz() {
    const { score, total } = calculateQuizResult();
    const resultEl = document.getElementById("quizResult");

    if (!total) {
      resultEl.textContent = "Сұрақтар жоқ.";
      resultEl.className = "result-text";
      return;
    }

    const percent = Math.round((score / total) * 100);
    let cls = "result-text";
    if (percent >= 70) cls += " success";
    else cls += " fail";

    resultEl.className = cls;
    resultEl.textContent = `Нәтиже: ${score}/${total} (${percent}%)`;

    try {
      if (tg && tg.sendData) {
        const payload = {
          type: "test_result",
          score,
          total,
          percent,
          lessonTitle: Стартап деген не
        };
        tg.sendData(JSON.stringify(payload));
      }
    } catch (e) {
      console.error("sendData error:", e);
    }
  }

  document.getElementById("submitQuizBtn").addEventListener("click", handleSubmitQuiz);

  // ================== INIT ==================
  (async function init() {
    try {
      setStatus("GitHub-тан деректер жүктелуде...");
      renderPdfLinks();      // PDF сілтемелерін бірден шығарамыз
      await loadQuestions(); // Тестті GitHub-тан жүктейміз
      setStatus("Барлық деректер жүктелді.");
      setGlobalError("");
    } catch (e) {
      console.error(e);
      setStatus("Қате пайда болды.");
      setGlobalError("GitHub-пен байланысты тексер.");
    }
  })();
</script>
</body>
</html>
