<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8" />
  <title>Mini LMS – ЭОО</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg-main: #020617;
      --bg-card: #020617;
      --bg-elevated: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --danger: #f97373;
      --success: #4ade80;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
      padding: 16px;
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      padding: 16px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .title-block p {
      margin: 2px 0 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      font-size: 0.8rem;
      color: var(--accent);
      background: rgba(15, 23, 42, 0.8);
      white-space: nowrap;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      margin-right: 4px;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .selectors {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    @media (max-width: 720px) {
      .selectors {
        grid-template-columns: 1fr;
      }
    }

    .select-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .select-group label {
      color: var(--text-muted);
    }

    .select-group select {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 0.82rem;
      outline: none;
    }

    .section-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 12px;
      margin-bottom: 14px;
    }

    @media (max-width: 720px) {
      .section-grid { grid-template-columns: 1fr; }
    }

    .section {
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      padding: 10px 12px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.05), #020617);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .section-tag {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
    }

    .section-body {
      font-size: 0.85rem;
      color: var(--text-muted);
      max-height: 230px;
      overflow-y: auto;
      padding-right: 4px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .link-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer;
      text-decoration: none;
    }

    .quiz-container { margin-top: 6px; }

    .question {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed var(--border-subtle);
    }

    .question-title {
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      margin-bottom: 2px;
    }

    .option input { transform: scale(0.9); }

    .quiz-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-primary {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.85rem;
      background: var(--accent);
      color: #020617;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .result-text {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .result-text.success { color: var(--success); }
    .result-text.fail    { color: var(--danger); }

    .error {
      font-size: 0.8rem;
      color: var(--danger);
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="header">
      <div class="title-block">
        <h1>ЭОО • Mini LMS</h1>
        <p id="lessonTitle">Сабақты таңдап алыңыз</p>
      </div>
      <div class="badge">Telegram WebApp</div>
    </div>

    <div class="status-bar">
      <div class="status-left">
        <div class="dot"></div>
        <span id="statusText">Сабақ параметрлерін таңдаңыз</span>
      </div>
      <span id="userName"></span>
    </div>

    <!-- Сынып / Бөлім / Тақырып таңдағышы -->
    <div class="selectors">
      <div class="select-group">
        <label for="classSelect">Сынып</label>
        <select id="classSelect">
          <option value="">Сыныпты таңдаңыз</option>
        </select>
      </div>
      <div class="select-group">
        <label for="sectionSelect">Бөлім</label>
        <select id="sectionSelect" disabled>
          <option value="">Бөлімді таңдаңыз</option>
        </select>
      </div>
      <div class="select-group">
        <label for="topicSelect">Тақырып</label>
        <select id="topicSelect" disabled>
          <option value="">Тақырыпты таңдаңыз</option>
        </select>
      </div>
    </div>

    <div class="section-grid">
      <!-- Презентация (PDF) -->
      <section class="section">
        <div class="section-header">
          <span class="section-title">Презентация (PDF)</span>
          <span class="section-tag">GitHub</span>
        </div>
        <div class="section-body" id="presentationBody">
          Алдымен сынып, бөлім және тақырыпты таңдаңыз.
        </div>
      </section>

      <!-- Теория (PDF) -->
      <section class="section">
        <div class="section-header">
          <span class="section-title">Теория (PDF)</span>
          <span class="section-tag">GitHub</span>
        </div>
        <div class="section-body" id="theoryBody">
          Алдымен сынып, бөлім және тақырыпты таңдаңыз.
        </div>
      </section>
    </div>

    <!-- Тест бөлігі -->
    <section class="section">
      <div class="section-header">
        <span class="section-title">Бақылау сұрақтары</span>
        <span class="section-tag">Тест • GitHub</span>
      </div>
      <div class="section-body">
        <div id="quizContainer" class="quiz-container">
          Алдымен тақырып таңдаңыз.
        </div>

        <div class="quiz-actions">
          <button id="submitQuizBtn" class="btn-primary" disabled>Тестті аяқтау</button>
          <span id="quizResult" class="result-text"></span>
        </div>
      </div>
    </section>

    <div id="globalError" class="error" style="display:none;"></div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    tg.ready();
  }

  function setUserName() {
    try {
      const user = tg?.initDataUnsafe?.user;
      if (user) {
        const name = (user.first_name || "") + " " + (user.last_name || "");
        document.getElementById("userName").textContent = name.trim();
      }
    } catch (e) {}
  }
  setUserName();

  function setStatus(text) {
    const el = document.getElementById("statusText");
    if (el) el.textContent = text;
  }

  function setGlobalError(msg) {
    const el = document.getElementById("globalError");
    if (!el) return;
    if (!msg) {
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = msg;
  }

  async function safeFetch(url) {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error("HTTP " + response.status + " – " + url);
    }
    return await response.text();
  }

  // ================== LESSON CONFIG ==================
  // МЫНАНЫҢ ІШІНДЕ БАРЛЫҚ САБАҚТАРДЫ ТІЗІП ШЫҒАСЫҢ
  // ӘР ЖОЛ – ЖЕКЕ САБАҚ
  const LESSONS = [
    {
      class: "8-сынып",
      section: "Интернет және желілер",
      topic: "IP-мекенжай және маска",
      lessonTitle: "IP-мекенжай және желі маскасы",
      theoryPdf: "https://github.com/username/repo/blob/main/lesson1/theory.pdf?raw=1",
      presentationPdf: "https://github.com/username/repo/blob/main/lesson1/presentation.pdf?raw=1",
      questionsUrl: "https://raw.githubusercontent.com/username/repo/main/lesson1/questions.txt"
    },
    {
      class: "8-сынып",
      section: "Интернет және желілер",
      topic: "DNS және домендер",
      lessonTitle: "Домендік атаулар және DNS",
      theoryPdf: "https://github.com/username/repo/blob/main/lesson2/theory.pdf?raw=1",
      presentationPdf: "https://github.com/username/repo/blob/main/lesson2/presentation.pdf?raw=1",
      questionsUrl: "https://raw.githubusercontent.com/username/repo/main/lesson2/questions.txt"
    },
    {
      class: "9-сынып",
      section: "Алгоритмдеу",
      topic: "Циклдер: While",
      lessonTitle: "While циклі",
      theoryPdf: "https://github.com/username/repo/blob/main/lesson3/theory.pdf?raw=1",
      presentationPdf: "https://github.com/username/repo/blob/main/lesson3/presentation.pdf?raw=1",
      questionsUrl: "https://raw.githubusercontent.com/username/repo/main/lesson3/questions.txt"
    },
    {
      class: "11-сынып",
      section: "Стартап",
      topic: "Стартап деген не? Стартап кезеңдері",
      lessonTitle: "Стартап деген не?",
      theoryPdf: "https://github.com/AR94NUR/telegram-lms/blob/main/lesson1/1-ТАҚЫРЫП.pdf",
      presentationPdf: "https://github.com/AR94NUR/telegram-lms/blob/main/lesson1/1-taqirip.pdf?raw=1",
      questionsUrl: "https://raw.githubusercontent.com/AR94NUR/telegram-lms/refs/heads/main/lesson1/questions.txt"
    }
  ];

  // ================== SELECTOR ЛОГИКАСЫ ==================

  const classSelect = document.getElementById("classSelect");
  const sectionSelect = document.getElementById("sectionSelect");
  const topicSelect = document.getElementById("topicSelect");

  let currentLesson = null;
  let quizData = [];

  function initClassOptions() {
    const classes = [...new Set(LESSONS.map(l => l.class))];
    for (const cls of classes) {
      const opt = document.createElement("option");
      opt.value = cls;
      opt.textContent = cls;
      classSelect.appendChild(opt);
    }
  }

  function updateSectionOptions() {
    sectionSelect.innerHTML = '<option value="">Бөлімді таңдаңыз</option>';
    topicSelect.innerHTML = '<option value="">Тақырыпты таңдаңыз</option>';
    sectionSelect.disabled = true;
    topicSelect.disabled = true;

    const cls = classSelect.value;
    if (!cls) return;

    const sections = [...new Set(
      LESSONS.filter(l => l.class === cls).map(l => l.section)
    )];

    for (const sec of sections) {
      const opt = document.createElement("option");
      opt.value = sec;
      opt.textContent = sec;
      sectionSelect.appendChild(opt);
    }

    sectionSelect.disabled = false;
  }

  function updateTopicOptions() {
    topicSelect.innerHTML = '<option value="">Тақырыпты таңдаңыз</option>';
    topicSelect.disabled = true;

    const cls = classSelect.value;
    const sec = sectionSelect.value;
    if (!cls || !sec) return;

    const topics = LESSONS
      .filter(l => l.class === cls && l.section === sec)
      .map(l => l.topic);

    for (const t of topics) {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      topicSelect.appendChild(opt);
    }

    topicSelect.disabled = false;
  }

  function onTopicSelected() {
    const cls = classSelect.value;
    const sec = sectionSelect.value;
    const topic = topicSelect.value;

    currentLesson = LESSONS.find(
      l => l.class === cls && l.section === sec && l.topic === topic
    ) || null;

    quizData = [];
    document.getElementById("quizContainer").textContent = "Сұрақтар жүктелуде...";
    document.getElementById("submitQuizBtn").disabled = true;
    document.getElementById("quizResult").textContent = "";
    setGlobalError("");

    if (!currentLesson) {
      document.getElementById("lessonTitle").textContent = "Сабақ табылмады";
      document.getElementById("presentationBody").textContent = "Бұл параметрлер үшін сабақ жоқ.";
      document.getElementById("theoryBody").textContent = "Бұл параметрлер үшін сабақ жоқ.";
      setStatus("Сабақ табылмады.");
      return;
    }

    document.getElementById("lessonTitle").textContent = currentLesson.lessonTitle || "Сабақ";
    renderPdfLinks();
    loadQuestions();
  }

  classSelect.addEventListener("change", () => {
    updateSectionOptions();
    document.getElementById("lessonTitle").textContent = "Сабақты таңдаңыз";
    document.getElementById("presentationBody").textContent = "Алдымен бөлім және тақырыпты таңдаңыз.";
    document.getElementById("theoryBody").textContent = "Алдымен бөлім және тақырыпты таңдаңыз.";
    document.getElementById("quizContainer").textContent = "Алдымен тақырып таңдаңыз.";
    document.getElementById("submitQuizBtn").disabled = true;
    document.getElementById("quizResult").textContent = "";
    setStatus("Бөлім мен тақырыпты таңдаңыз.");
  });

  sectionSelect.addEventListener("change", () => {
    updateTopicOptions();
    document.getElementById("lessonTitle").textContent = "Сабақты таңдаңыз";
    document.getElementById("presentationBody").textContent = "Алдымен тақырыпты таңдаңыз.";
    document.getElementById("theoryBody").textContent = "Алдымен тақырыпты таңдаңыз.";
    document.getElementById("quizContainer").textContent = "Алдымен тақырып таңдаңыз.";
    document.getElementById("submitQuizBtn").disabled = true;
    document.getElementById("quizResult").textContent = "";
    setStatus("Тақырыпты таңдаңыз.");
  });

  topicSelect.addEventListener("change", () => {
    if (!topicSelect.value) return;
    setStatus("Сабақ деректері жүктелуде...");
    onTopicSelected();
  });

  // ================== PDF LINK РЕНДЕР ==================

  function renderPdfLinks() {
    const presBody = document.getElementById("presentationBody");
    const theoryBody = document.getElementById("theoryBody");

    presBody.innerHTML = "";
    theoryBody.innerHTML = "";

    if (!currentLesson) {
      presBody.textContent = "Сабақ таңдалмаған.";
      theoryBody.textContent = "Сабақ таңдалмаған.";
      return;
    }

    if (currentLesson.presentationPdf) {
      const a = document.createElement("a");
      a.href = currentLesson.presentationPdf;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.className = "link-btn";
      a.textContent = "Презентацияны ашу (PDF)";
      presBody.appendChild(a);
    } else {
      presBody.textContent = "Презентация PDF сілтемесі орнатылмаған.";
    }

    if (currentLesson.theoryPdf) {
      const a = document.createElement("a");
      a.href = currentLesson.theoryPdf;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.className = "link-btn";
      a.textContent = "Теорияны ашу (PDF)";
      theoryBody.appendChild(a);
    } else {
      theoryBody.textContent = "Теория PDF сілтемесі орнатылмаған.";
    }
  }

  // ================== ТЕСТ СҰРАҚТАРЫ ==================

  function parseQuestions(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const result = [];

    for (const line of lines) {
      const parts = line.split("|").map(p => p.trim());
      if (parts.length < 6) continue;

      const [q, a, b, c, d, correctRaw] = parts;
      const correctIndex = parseInt(correctRaw, 10) - 1;

      if (isNaN(correctIndex) || correctIndex < 0 || correctIndex > 3) continue;

      result.push({
        text: q,
        options: [a, b, c, d],
        correctIndex
      });
    }

    return result;
  }

  function renderQuiz() {
    const container = document.getElementById("quizContainer");
    if (!quizData.length) {
      container.textContent = "Сұрақтар әзірге жоқ.";
      document.getElementById("submitQuizBtn").disabled = true;
      return;
    }

    container.innerHTML = "";

    quizData.forEach((q, qi) => {
      const qDiv = document.createElement("div");
      qDiv.className = "question";

      const title = document.createElement("div");
      title.className = "question-title";
      title.textContent = (qi + 1) + ". " + q.text;
      qDiv.appendChild(title);

      q.options.forEach((opt, oi) => {
        const label = document.createElement("label");
        label.className = "option";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "q" + qi;
        input.value = String(oi);

        label.appendChild(input);
        label.appendChild(document.createTextNode(opt));
        qDiv.appendChild(label);
      });

      container.appendChild(qDiv);
    });

    document.getElementById("submitQuizBtn").disabled = false;
  }

  async function loadQuestions() {
    const container = document.getElementById("quizContainer");

    if (!currentLesson || !currentLesson.questionsUrl) {
      container.textContent = "Бұл тақырып үшін сұрақтар сілтемесі орнатылмаған.";
      document.getElementById("submitQuizBtn").disabled = true;
      setStatus("Сұрақтар табылмады.");
      return;
    }

    try {
      setStatus("Сұрақтар жүктелуде...");
      const text = await safeFetch(currentLesson.questionsUrl);
      quizData = parseQuestions(text);
      renderQuiz();
      setStatus("Сабақ жүктелді.");
      setGlobalError("");
    } catch (e) {
      console.error(e);
      container.textContent = "Сұрақтарды жүктеу кезінде қате.";
      setGlobalError("Тест сұрақтарын GitHub-тен жүктеу мүмкін болмады.");
      document.getElementById("submitQuizBtn").disabled = true;
      setStatus("Қате пайда болды.");
    }
  }

  function calculateQuizResult() {
    if (!quizData.length) return { score: 0, total: 0 };

    let correct = 0;
    quizData.forEach((q, qi) => {
      const selected = document.querySelector('input[name="q' + qi + '"]:checked');
      if (!selected) return;
      const idx = parseInt(selected.value, 10);
      if (idx === q.correctIndex) correct++;
    });

    return { score: correct, total: quizData.length };
  }

  function handleSubmitQuiz() {
    const { score, total } = calculateQuizResult();
    const resultEl = document.getElementById("quizResult");

    if (!total) {
      resultEl.textContent = "Сұрақтар жоқ.";
      resultEl.className = "result-text";
      return;
    }

    const percent = Math.round((score / total) * 100);
    let cls = "result-text";
    if (percent >= 70) cls += " success";
    else cls += " fail";

    resultEl.className = cls;
    resultEl.textContent = `Нәтиже: ${score}/${total} (${percent}%)`;

    try {
      if (tg && tg.sendData) {
        const payload = {
          type: "test_result",
          score,
          total,
          percent,
          lessonTitle: currentLesson?.lessonTitle || ""
        };
        tg.sendData(JSON.stringify(payload));
      }
    } catch (e) {
      console.error("sendData error:", e);
    }
  }

  document.getElementById("submitQuizBtn").addEventListener("click", handleSubmitQuiz);

  // ================== INIT ==================
  (function init() {
    initClassOptions();
    setStatus("Сыныпты таңдаңыз.");
  })();
</script>
</body>
</html>

